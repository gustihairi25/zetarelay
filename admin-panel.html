<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Admin Master Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="config.js"></script>
    <style>
        body { background: #000; color: #eee; font-family: sans-serif; height: 100vh; overflow: hidden; }
        .tab-content { display: none; height: calc(100vh - 80px); }
        .tab-active { display: flex; flex-direction: column; }
        .glass { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body class="p-6">
    <header class="flex justify-between items-center mb-6">
        <h1 class="text-xl font-black italic text-yellow-500 uppercase">MASTER HUB</h1>
        <nav class="flex gap-4">
            <button onclick="st('users')" class="text-[10px] font-bold uppercase py-2">Users Control</button>
            <button onclick="st('chats')" class="text-[10px] font-bold uppercase py-2">Chats</button>
        </nav>
    </header>

    <div id="tab-users" class="tab-content tab-active overflow-y-auto">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="user-list"></div>
    </div>

    <div id="tab-chats" class="tab-content h-full">
        <div class="flex h-full gap-4">
            <div class="w-1/4 glass rounded-3xl p-4 overflow-y-auto" id="contact-list"></div>
            <div class="flex-1 glass rounded-3xl flex flex-col">
                <div id="chat-header" class="p-4 border-b border-white/10 text-xs font-black">CHAT</div>
                <div id="chat-box" class="flex-1 p-4 overflow-y-auto flex flex-col gap-3"></div>
                <div id="reply-area" class="p-4 border-t border-white/10 hidden flex gap-2">
                    <input type="text" id="admin-msg" class="flex-1 bg-black border border-white/10 rounded-xl px-4" placeholder="Balas...">
                    <button onclick="reply()" class="bg-yellow-500 text-black px-6 py-2 rounded-xl font-black">Kirim</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, updateDoc, query, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(APP_CONFIG.firebase);
        const db = getFirestore(app);
        let activeUID = null;
        const coins = ['BTC', 'ETH', 'SOL', 'TRX', 'LINEA', 'ARB', 'BNB', 'BASE', 'OP', 'MATIC'];

        window.st = (t) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('tab-active'));
            document.getElementById('tab-' + t).classList.add('tab-active');
        };

        onSnapshot(collection(db, "users"), (snap) => {
            const uList = document.getElementById('user-list');
            const cList = document.getElementById('contact-list');
            uList.innerHTML = ''; cList.innerHTML = '';
            snap.forEach(d => {
                const u = d.data(); const id = d.id;
                let cHtml = `<div class="mb-4 text-yellow-500">Saldo Trading: <input type="number" value="${u.balance||0}" id="bal-trade-${id}" class="bg-black border border-white/20 p-1 w-24"> <button onclick="upBal('${id}')" class="bg-yellow-500 text-black px-2 rounded">SET</button></div>`;
                coins.forEach(c => {
                    cHtml += `<div class="flex justify-between items-center text-[10px] mb-1"><span>${c}</span> <div><input type="number" step="any" value="${u[c.toLowerCase()+'_bal']||0}" id="bal-${c}-${id}" class="bg-black border border-white/20 p-1 w-20"> <button onclick="upCoin('${id}','${c}')" class="bg-yellow-500 text-black px-1 rounded">SET</button></div></div>`;
                });
                uList.innerHTML += `<div class="glass p-4 rounded-3xl font-bold">${u.email}<hr class="my-2 border-white/10">${cHtml}</div>`;
                
                const unread = u.lastMsgBy === 'user' && !u.lastRead;
                cList.innerHTML += `<div onclick="openChat('${id}','${u.email}')" class="p-3 mb-2 rounded-xl cursor-pointer ${unread?'bg-red-500/20':'bg-white/5'} font-bold">${u.email.split('@')[0]} ${unread?'ðŸ”´':''}</div>`;
            });
        });

        window.upBal = async (uid) => {
            const val = parseFloat(document.getElementById(`bal-trade-${uid}`).value);
            await updateDoc(doc(db, "users", uid), { balance: val });
        };

        window.upCoin = async (uid, c) => {
            const val = parseFloat(document.getElementById(`bal-${c}-${uid}`).value);
            const up = {}; up[`${c.toLowerCase()}_bal`] = val;
            await updateDoc(doc(db, "users", uid), up);
        };

        window.openChat = async (uid, email) => {
            activeUID = uid; document.getElementById('reply-area').classList.remove('hidden');
            document.getElementById('chat-header').innerText = email;
            await updateDoc(doc(db, "users", uid), { lastRead: true });
            onSnapshot(query(collection(db, "users", uid, "chats"), orderBy("timestamp", "asc")), (sn) => {
                const box = document.getElementById('chat-box'); box.innerHTML = '';
                sn.forEach(d => {
                    const m = d.data();
                    box.innerHTML += `<div class="${m.sender==='admin'?'self-end bg-yellow-500 text-black':'self-start bg-white/10 text-white'} p-3 rounded-2xl text-[11px] font-bold max-w-[80%]">${m.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        window.reply = async () => {
            const inp = document.getElementById('admin-msg'); if(!inp.value || !activeUID) return;
            await addDoc(collection(db, "users", activeUID, "chats"), { sender:'admin', text:inp.value, timestamp:serverTimestamp() });
            await updateDoc(doc(db, "users", activeUID), { lastMsgBy:'admin' });
            inp.value = '';
        };
        lucide.createIcons();
    </script>
</body>
</html>

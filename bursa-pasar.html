<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bursa & Investasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background: #000; color: #eee; font-family: 'Inter', sans-serif; opacity: 0; transition: opacity 0.5s; }
        .glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(15px); }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-black pb-10">

    <div class="p-6 sticky top-0 bg-black/80 backdrop-blur-lg z-50 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <button onclick="window.location.href='dashboard.html'" class="p-2 glass rounded-xl text-yellow-500"><i data-lucide="chevron-left"></i></button>
            <h1 class="text-xl font-black italic uppercase tracking-tighter">Bursa Saham</h1>
        </div>
        <div class="text-right">
            <p class="text-[8px] font-bold text-gray-500 uppercase">Saldo</p>
            <p id="user-balance" class="text-sm font-black text-yellow-500">Rp 0</p>
        </div>
    </div>

    <div class="px-6 mb-8">
        <div class="glass p-6 rounded-[2.5rem] border border-yellow-500/10">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-1">Total Investasi</p>
            <h2 id="total-invest" class="text-3xl font-black italic">Rp 0</h2>
            <p id="asset-count" class="text-xs font-bold text-white mt-2">0 Aset</p>
        </div>
    </div>

    <div class="px-6 space-y-4" id="market-list">
        <div class="glass p-5 rounded-3xl flex justify-between items-center">
            <div><p class="font-black text-sm uppercase">Bitcoin (BTC)</p><p class="text-[9px] text-gray-500">Rp 950.000.000</p></div>
            <button onclick="beliAset('BTC', 950000000)" class="px-5 py-3 bg-yellow-500 text-black text-[10px] font-black rounded-xl uppercase">Beli</button>
        </div>
        <div class="glass p-5 rounded-3xl flex justify-between items-center">
            <div><p class="font-black text-sm uppercase">Ethereum (ETH)</p><p class="text-[9px] text-gray-500">Rp 45.000.000</p></div>
            <button onclick="beliAset('ETH', 450000000)" class="px-5 py-3 bg-white text-black text-[10px] font-black rounded-xl uppercase">Beli</button>
        </div>
    </div>

    <div id="modal-buy" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-xl hidden flex items-center justify-center p-6">
        <div class="w-full max-w-sm glass p-8 rounded-[2.5rem]">
            <h2 class="text-xl font-black text-yellow-500 mb-2 italic">Beli <span id="buy-name"></span></h2>
            <input type="number" id="buy-amount" placeholder="Nominal Rp" class="w-full p-4 bg-white/5 border border-white/10 rounded-2xl outline-none text-white mb-6">
            <div class="flex gap-2">
                <button onclick="closeModal()" class="flex-1 py-4 bg-white/5 text-white font-black rounded-2xl text-[10px]">BATAL</button>
                <button onclick="konfirmasiBeli()" class="flex-[2] py-4 bg-yellow-500 text-black font-black rounded-2xl text-[10px]">KONFIRMASI</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDrpBJTtankyLgimtOwuriFpiyuC5K10OI", 
            authDomain: "studio-727777898-40aea.firebaseapp.com", 
            projectId: "studio-727777898-40aea", 
            appId: "1:351263967108:web:a0c01af41422903cc17fd1" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userBalance = 0; let sAset = ""; let sHarga = 0; let currentUid = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUid = user.uid;
                document.body.style.opacity = "1";
                // Sync Saldo
                onSnapshot(doc(db, "users", user.uid), (s) => {
                    if(s.exists()){
                        userBalance = s.data().balance || 0;
                        document.getElementById('user-balance').innerText = "Rp " + userBalance.toLocaleString();
                    }
                });
                // Sync Portofolio
                onSnapshot(collection(db, "users", user.uid, "investments"), (s) => {
                    let total = 0; s.forEach(doc => total += doc.data().amountRp);
                    document.getElementById('total-invest').innerText = "Rp " + total.toLocaleString();
                    document.getElementById('asset-count').innerText = s.size + " Aset";
                });
            } else {
                window.location.href = "login.html";
            }
        });

        window.beliAset = (n, h) => { sAset=n; sHarga=h; document.getElementById('buy-name').innerText=n; document.getElementById('modal-buy').classList.remove('hidden'); };
        window.closeModal = () => document.getElementById('modal-buy').classList.add('hidden');
        window.konfirmasiBeli = async () => {
            const amt = parseInt(document.getElementById('buy-amount').value);
            if(amt > userBalance) return alert("Saldo Kurang!");
            if(!amt || amt < 100000) return alert("Min Rp 100.000");
            try {
                await updateDoc(doc(db, "users", currentUid), { balance: userBalance - amt });
                await addDoc(collection(db, "users", currentUid, "investments"), { assetName: sAset, amountRp: amt, buyPrice: sHarga, timestamp: serverTimestamp() });
                alert("Berhasil!"); closeModal();
            } catch (e) { alert(e.message); }
        };
        lucide.createIcons();
    </script>
</body>
</html>

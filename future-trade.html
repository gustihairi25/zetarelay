<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trade | ZetaChain</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { background: #000; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; }
        .bg-card { background: #0f0f0f; border: 1px solid #1a1a1a; }
        .gold-text { color: #f3ba2f; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div class="p-4 border-b border-white/5 flex items-center justify-between bg-black">
        <div class="flex items-center gap-3">
            <button onclick="window.location.href='dashboard.html'" class="p-2 bg-card rounded-lg text-gray-400">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
            </button>
            <h1 class="font-black italic gold-text">BTC/USDT <span class="text-[8px] bg-yellow-500/20 px-2 py-1 rounded">LIVE</span></h1>
        </div>
        <button onclick="window.location.href='livechat.html'" class="p-2 text-yellow-500"><i data-lucide="headset" class="w-5 h-5"></i></button>
    </div>

    <div class="flex-grow"><div id="tv_trade" class="h-full"></div></div>

    <div class="bg-card p-6 rounded-t-[3rem] border-t border-white/10 space-y-4">
        <div class="flex justify-between text-[10px] font-black text-gray-500 uppercase italic px-2">
            <span>Portfolio: <span id="user-idr" class="text-white">Rp 0</span></span>
            <span class="text-yellow-500">Node: Active</span>
        </div>

        <input type="number" id="trade-amt" placeholder="Nominal IDR" class="w-full bg-black border border-white/10 p-5 rounded-2xl outline-none focus:border-yellow-500 font-black italic">

        <div class="grid grid-cols-2 gap-4">
            <button onclick="trade('BUY')" class="bg-green-600 py-5 rounded-2xl font-black italic active:scale-95 transition-all">LONG</button>
            <button onclick="trade('SELL')" class="bg-red-600 py-5 rounded-2xl font-black italic active:scale-95 transition-all">SHORT</button>
        </div>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const app = initializeApp(APP_CONFIG.firebase);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let balance = 0, uid = "";

        onAuthStateChanged(auth, (u) => {
            if(u) {
                uid = u.uid;
                onSnapshot(doc(db, "users", uid), (s) => {
                    if(s.exists()){
                        // Disini kita menggunakan field 'balance' sebagai saldo trading utama
                        balance = s.data().balance || 0;
                        document.getElementById('user-idr').innerText = "Rp " + balance.toLocaleString('id-ID');
                    }
                });
            } else window.location.href="login.html";
        });

        new TradingView.widget({
            "autosize": true, "symbol": "BINANCE:BTCUSDT", "interval": "1",
            "theme": "dark", "style": "1", "container_id": "tv_trade",
            "hide_top_toolbar": true
        });

        window.trade = async (type) => {
            const amt = parseInt(document.getElementById('trade-amt').value);
            if(!amt || amt < 50000) return alert("Minimal Rp 50.000");
            if(amt > balance) return alert("Saldo Tidak Cukup");

            try {
                await updateDoc(doc(db, "users", uid), { balance: balance - amt });
                await addDoc(collection(db, "users", uid, "transactions"), {
                    title: `Future Trade ${type}`, amount: amt, status: "Berjalan", timestamp: serverTimestamp()
                });
                alert("Trade Berhasil!");
                window.location.href = "dashboard.html";
            } catch(e) { alert("Error database."); }
        };
        lucide.createIcons();
    </script>
</body>
</html>

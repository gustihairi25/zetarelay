<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Support | ZetaChain</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="config.js"></script>
    <style>
        body { background: #000; color: #fff; height: 100vh; display: flex; flex-direction: column; }
        .bubble-user { background: #f3ba2f; color: #000; align-self: flex-end; padding: 12px; border-radius: 1.2rem 1.2rem 0.2rem 1.2rem; margin-bottom: 8px; font-weight: 700; font-size: 13px; max-width: 80%; }
        .bubble-admin { background: #1a1a1a; color: #fff; align-self: flex-start; padding: 12px; border-radius: 1.2rem 1.2rem 1.2rem 0.2rem; border: 1px solid #333; margin-bottom: 8px; font-weight: 700; font-size: 13px; max-width: 80%; }
    </style>
</head>
<body>
    <div class="p-4 border-b border-white/10 flex items-center gap-4 bg-black">
        <button onclick="window.location.href='dashboard.html'"><i data-lucide="chevron-left"></i></button>
        <h1 class="text-sm font-black uppercase italic">Live Support</h1>
    </div>

    <div id="chat-container" class="flex-1 overflow-y-auto p-4 flex flex-col"></div>

    <div class="p-4 bg-black border-t border-white/10 flex gap-2">
        <input type="text" id="msg-input" class="flex-1 bg-[#111] border-none rounded-xl px-4 text-sm font-bold" placeholder="Tulis pesan...">
        <button id="btn-send" class="w-12 h-12 bg-yellow-500 text-black rounded-xl flex items-center justify-center"><i data-lucide="send" class="w-5 h-5"></i></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, query, orderBy, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const app = initializeApp(APP_CONFIG.firebase);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let user = null;

        onAuthStateChanged(auth, (u) => { if(u) { user = u; load(); } });

        function load() {
            onSnapshot(query(collection(db, "users", user.uid, "chats"), orderBy("timestamp", "asc")), (sn) => {
                const box = document.getElementById('chat-container'); box.innerHTML = '';
                sn.forEach(d => {
                    const m = d.data();
                    box.innerHTML += `<div class="${m.sender==='admin'?'bubble-admin':'bubble-user'}">${m.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        document.getElementById('btn-send').onclick = async () => {
            const inp = document.getElementById('msg-input');
            if(!inp.value.trim() || !user) return;
            await addDoc(collection(db, "users", user.uid, "chats"), { sender:'user', text:inp.value, timestamp:serverTimestamp() });
            await updateDoc(doc(db, "users", user.uid), { lastMsgBy:'user', lastRead:false });
            inp.value = '';
        };
        lucide.createIcons();
    </script>
</body>
</html>

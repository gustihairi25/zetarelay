<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirim & Minta | CryptoPro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { background-color: #000; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; }
        .bg-card { background: #0f0f0f; border: 1px solid #1a1a1a; }
        .input-glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); }
        .gold-text { color: #f3ba2f; }
    </style>
</head>
<body class="p-6">
    <div class="flex items-center gap-4 mb-8">
        <button onclick="location.href='dashboard.html'" class="text-gray-500"><i class="fa-solid fa-chevron-left text-xl"></i></button>
        <h1 class="text-sm font-black italic uppercase">Kirim & Minta <span class="text-yellow-500">Saldo</span></h1>
    </div>

    <!-- Search Section -->
    <div class="mb-8">
        <p class="text-[10px] text-gray-500 font-bold uppercase mb-3 tracking-widest">Cari Pengguna</p>
        <div class="relative">
            <input type="text" id="search-input" placeholder="Masukkan Email atau UID..." 
                   class="w-full input-glass p-5 rounded-2xl text-xs focus:border-yellow-500 outline-none transition-all">
            <button id="btn-search" class="absolute right-4 top-1/2 -translate-y-1/2 bg-yellow-500 text-black px-4 py-2 rounded-xl text-[10px] font-black uppercase">Cari</button>
        </div>
    </div>

    <!-- Result Section (Hidden by default) -->
    <div id="result-box" class="hidden animate-pulse">
        <div class="bg-card p-6 rounded-[2rem] border border-white/5 text-center mb-6">
            <div id="res-avatar" class="w-20 h-20 bg-yellow-500 rounded-[2rem] flex items-center justify-center mx-auto mb-4 text-black text-2xl font-black uppercase">?</div>
            <h2 id="res-name" class="text-lg font-black italic mb-1 uppercase">User Name</h2>
            <p id="res-email" class="text-[10px] text-gray-500 font-bold mb-6">user@email.com</p>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="openAction('SEND')" class="bg-white text-black py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest active:scale-95 transition-all">Kirim Saldo</button>
                <button onclick="openAction('REQUEST')" class="border border-white/20 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest active:scale-95 transition-all">Minta Saldo</button>
            </div>
        </div>
    </div>

    <!-- Action Modal (Hidden) -->
    <div id="modal-action" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-6 z-50">
        <div class="bg-card w-full p-8 rounded-[2.5rem] border border-white/10">
            <h3 id="modal-title" class="text-center font-black italic uppercase mb-6 text-yellow-500 tracking-tighter text-xl">TRANSAKSI</h3>
            
            <div class="mb-6">
                <p class="text-[8px] text-gray-500 font-bold uppercase mb-2">Nominal Rupiah (Rp)</p>
                <input type="number" id="amount-input" placeholder="Min. Rp 10.000" 
                       class="w-full bg-white/5 border border-white/10 p-5 rounded-2xl text-lg font-black outline-none focus:border-yellow-500">
            </div>

            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-4 text-[10px] font-black uppercase text-gray-500">Batal</button>
                <button id="btn-confirm" class="flex-1 bg-yellow-500 text-black py-4 rounded-2xl font-black text-[10px] uppercase shadow-lg shadow-yellow-500/20">Konfirmasi</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, getDocs, doc, getDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDrpBJTtankyLgimtOwuriFpiyuC5K10OI",
            authDomain: "studio-727777898-40aea.firebaseapp.com",
            projectId: "studio-727777898-40aea",
            appId: "1:351263967108:web:a0c01af41422903cc17fd1"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentTarget = null;
        let actionType = '';

        document.getElementById('btn-search').onclick = async () => {
            const input = document.getElementById('search-input').value.toLowerCase().trim();
            if(!input) return;

            const box = document.getElementById('result-box');
            box.classList.add('hidden');

            try {
                // 1. Cek by UID dulu
                let targetDoc = await getDoc(doc(db, "users", input));
                
                // 2. Jika tidak ada, cek by Email
                if(!targetDoc.exists()) {
                    const q = query(collection(db, "users"));
                    const snap = await getDocs(q);
                    snap.forEach(d => {
                        if(d.data().email && d.data().email.toLowerCase() === input) {
                            targetDoc = d;
                        }
                    });
                }

                if(targetDoc && targetDoc.exists()) {
                    const data = targetDoc.data();
                    currentTarget = { id: targetDoc.id, ...data };
                    
                    document.getElementById('res-name').innerText = (data.name || "User Crypto").toUpperCase();
                    document.getElementById('res-email').innerText = data.email || "Private Email";
                    document.getElementById('res-avatar').innerText = (data.name || data.email || "?")[0];
                    box.classList.remove('hidden');
                    box.classList.remove('animate-pulse');
                } else {
                    alert("Pengguna tidak ditemukan!");
                }
            } catch(e) { alert("Error: " + e.message); }
        };

        window.openAction = (type) => {
            actionType = type;
            document.getElementById('modal-title').innerText = type === 'SEND' ? 'KIRIM SALDO' : 'MINTA SALDO';
            document.getElementById('modal-action').classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('modal-action').classList.add('hidden');
        };

        document.getElementById('btn-confirm').onclick = async () => {
            const amount = parseInt(document.getElementById('amount-input').value);
            if(!amount || amount < 10000) return alert("Minimal Rp 10.000");

            const user = auth.currentUser;
            if(!user) return;

            try {
                // Kirim notifikasi ke Admin/Sistem untuk diproses
                await addDoc(collection(db, "users", user.uid, "chats"), {
                    sender: 'user',
                    text: `ðŸš¨ [${actionType}] Permintaan ${actionType === 'SEND' ? 'Kirim' : 'Minta'} Saldo sebesar Rp ${amount.toLocaleString()} ke user: ${currentTarget.id} (${currentTarget.email})`,
                    timestamp: serverTimestamp()
                });

                alert("Permintaan berhasil dikirim! Admin akan memvalidasi transaksi ini.");
                closeModal();
                window.location.href = 'dashboard.html';
            } catch(e) { alert("Gagal: " + e.message); }
        };
    </script>
</body>
</html>


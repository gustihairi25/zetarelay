<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Top Up | ZetaChain Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { background: #050505; color: white; font-family: 'Plus Jakarta Sans', sans-serif; }
        .bg-card { background: #111; border: 1px solid #222; }
        .gold-text { color: #f3ba2f; }
        .coin-btn { transition: all 0.2s; opacity: 0.6; border: 1px solid #222; }
        .coin-btn.active { opacity: 1; border-color: #f3ba2f; background: rgba(243, 186, 47, 0.1); transform: scale(1.05); }
        #preview-img { display: none; width: 100%; border-radius: 12px; margin-top: 10px; border: 1px solid #333; }
    </style>
</head>
<body class="p-6 pb-24">

    <div class="flex items-center gap-4 mb-8">
        <button onclick="window.location.href='dashboard.html'" class="p-2 bg-card rounded-xl text-yellow-500">
            <i data-lucide="arrow-left"></i>
        </button>
        <h1 class="text-lg font-black italic gold-text uppercase">Deposit Terminal</h1>
    </div>

    <div class="mb-8">
        <p class="text-[9px] font-black text-gray-500 uppercase tracking-widest mb-4 italic">1. Pilih Koin Pembayaran</p>
        <div id="coin-list" class="grid grid-cols-2 gap-3">
            </div>
    </div>

    <div id="form-deposit" class="hidden space-y-6">
        <div class="bg-card p-6 rounded-[2rem] border border-white/5 space-y-5 shadow-2xl">
            <div>
                <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">2. Jumlah Deposit (IDR)</label>
                <input type="number" id="amount" placeholder="Min. Rp 50.000" class="w-full bg-black border border-white/10 p-4 rounded-2xl mt-2 outline-none focus:border-yellow-500 font-bold text-white">
            </div>

            <div class="p-4 bg-yellow-500/5 border border-yellow-500/20 rounded-2xl">
                <p class="text-[9px] font-bold text-yellow-500 uppercase mb-2">Alamat Tujuan <span id="coin-name">...</span></p>
                <div class="flex items-center justify-between gap-2">
                    <code id="addr-text" class="text-[10px] font-mono break-all text-gray-300">...</code>
                    <button onclick="copyAddr()" class="p-2 bg-yellow-500 text-black rounded-lg active:scale-90"><i data-lucide="copy" class="w-4 h-4"></i></button>
                </div>
            </div>

            <div>
                <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">3. Bukti Transfer (Screenshot)</label>
                <div onclick="document.getElementById('file-up').click()" class="w-full bg-black border-2 border-dashed border-white/10 p-6 rounded-2xl mt-2 flex flex-col items-center justify-center cursor-pointer">
                    <i data-lucide="image" class="text-gray-500 mb-1"></i>
                    <span id="up-label" class="text-[9px] text-gray-500 font-bold">KLIK UNTUK UPLOAD</span>
                    <input type="file" id="file-up" accept="image/*" class="hidden" onchange="handleFile()">
                    <img id="preview-img" src="">
                </div>
            </div>
        </div>

        <button id="btn-confirm" onclick="sendData()" class="w-full py-5 bg-yellow-500 text-black rounded-[2rem] font-black uppercase italic shadow-lg active:scale-95 transition-all">
            Konfirmasi Transfer
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Inisialisasi menggunakan config.js
        const app = initializeApp(APP_CONFIG.firebase);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const list = document.getElementById('coin-list');
        const coins = Object.keys(APP_CONFIG.depositAddresses);
        let selected = "", uid = "", base64 = "";

        // Tampilkan 10 Koin
        coins.forEach(c => {
            const div = document.createElement('div');
            div.className = "coin-btn bg-card p-4 rounded-2xl text-center font-black italic gold-text text-xs";
            div.innerText = c;
            div.onclick = () => {
                selected = c;
                document.querySelectorAll('.coin-btn').forEach(b => b.classList.remove('active'));
                div.classList.add('active');
                document.getElementById('form-deposit').classList.remove('hidden');
                document.getElementById('coin-name').innerText = c;
                document.getElementById('addr-text').innerText = APP_CONFIG.depositAddresses[c];
            };
            list.appendChild(div);
        });

        window.handleFile = () => {
            const file = document.getElementById('file-up').files[0];
            const reader = new FileReader();
            reader.onloadend = () => {
                base64 = reader.result;
                document.getElementById('preview-img').src = reader.result;
                document.getElementById('preview-img').style.display = 'block';
                document.getElementById('up-label').innerText = "GAMBAR SIAP";
            };
            if(file) reader.readAsDataURL(file);
        };

        window.copyAddr = () => {
            navigator.clipboard.writeText(APP_CONFIG.depositAddresses[selected]);
            alert("Alamat " + selected + " disalin!");
        };

        onAuthStateChanged(auth, (user) => { if(user) uid = user.uid; else window.location.href="login.html"; });

        window.sendData = async () => {
            const amt = document.getElementById('amount').value;
            const btn = document.getElementById('btn-confirm');

            if(!amt || amt < 50000 || !base64) return alert("Lengkapi data dan bukti transfer!");

            btn.innerText = "MEMPROSES...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, "users", uid, "transactions"), {
                    title: `Deposit ${selected}`,
                    amount: parseInt(amt),
                    status: "Pending",
                    type: "Deposit",
                    proof: base64,
                    timestamp: serverTimestamp()
                });
                alert("Deposit diajukan! Admin akan memverifikasi.");
                window.location.href = "dashboard.html";
            } catch (e) {
                alert("Kesalahan koneksi database.");
                btn.disabled = false;
                btn.innerText = "Konfirmasi Transfer";
            }
        };

        lucide.createIcons();
    </script>
</body>
</html>
